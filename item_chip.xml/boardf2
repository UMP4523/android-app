package com.example.myapplication;

import android.content.Intent;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;
import androidx.recyclerview.widget.LinearLayoutManager;

import com.example.myapplication.databinding.FragmentBoardBinding;
import com.google.firebase.firestore.FirebaseFirestore;
import com.google.firebase.firestore.QueryDocumentSnapshot;

import java.util.ArrayList;

public class BoardFragment extends Fragment {

    private FragmentBoardBinding binding;
    private BoardAdapter adapter;
    private ArrayList<BoardPost> postList = new ArrayList<>();
    private FirebaseFirestore db;
    private String storeId; // ✅ 가게 구분용

    @Nullable
    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {
        binding = FragmentBoardBinding.inflate(inflater, container, false);
        db = FirebaseFirestore.getInstance();

        if (getArguments() != null) {
            storeId = getArguments().getString("storeId"); // ✅ 가게 ID 받기
        }

        setupRecyclerView();
        loadPostsFromFirebase();

        binding.fabAddPost.setOnClickListener(v -> {
            Intent intent = new Intent(getActivity(), BoardWriteActivity.class);
            intent.putExtra("storeId", storeId);
            startActivity(intent);
        });

        return binding.getRoot();
    }

    private void setupRecyclerView() {
        adapter = new BoardAdapter(getContext(), postList);
        binding.recyclerViewBoard.setLayoutManager(new LinearLayoutManager(getContext()));
        binding.recyclerViewBoard.setAdapter(adapter);
    }

    // ✅ Firebase에서 현재 가게(storeId) 게시글만 불러오기
    private void loadPostsFromFirebase() {
        db.collection("board_posts")
                .whereEqualTo("storeId", storeId)
                .get()
                .addOnSuccessListener(querySnapshot -> {
                    postList.clear();
                    for (QueryDocumentSnapshot doc : querySnapshot) {
                        BoardPost post = doc.toObject(BoardPost.class);
                        postList.add(post);
                    }
                    adapter.notifyDataSetChanged();
                });
    }

    @Override
    public void onDestroyView() {
        super.onDestroyView();
        binding = null;
    }
}
