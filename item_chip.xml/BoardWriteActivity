package com.example.myapplication;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Bundle;
import android.text.Editable;
import android.text.Spannable;
import android.text.SpannableStringBuilder;
import android.text.TextWatcher;
import android.text.style.ImageSpan;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;
import android.widget.Toast;

import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;

import java.io.InputStream;
import java.lang.reflect.Type;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Locale;

public class BoardWriteActivity extends AppCompatActivity {

    private EditText editTitle, editContent;
    private TextView textCharCount;
    private ArrayList<String> imageUris = new ArrayList<>();

    private static final int MAX_CONTENT_LENGTH = 1000;
    private static final String PREFS_NAME = "BoardPrefs";
    private static final String POSTS_KEY = "board_posts";

    private ActivityResultLauncher<Intent> imagePickerLauncher;

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_board_write);

        editTitle = findViewById(R.id.edit_post_title);
        editContent = findViewById(R.id.edit_post_content);
        textCharCount = findViewById(R.id.text_char_count);

        Button addPhotoButton = findViewById(R.id.button_add_photo);
        Button saveButton = findViewById(R.id.button_save_post);

        // ✅ 글자수 표시
        editContent.addTextChangedListener(new TextWatcher() {
            @Override public void beforeTextChanged(CharSequence s, int start, int count, int after) {}
            @Override public void onTextChanged(CharSequence s, int start, int before, int count) {
                updateCharCount();
            }
            @Override public void afterTextChanged(Editable s) {}
        });

        // ✅ 이미지 선택 런처
        imagePickerLauncher = registerForActivityResult(
                new ActivityResultContracts.StartActivityForResult(),
                result -> {
                    if (result.getResultCode() == Activity.RESULT_OK && result.getData() != null) {
                        Uri selectedImageUri = result.getData().getData();
                        if (selectedImageUri != null) {
                            imageUris.add(selectedImageUri.toString());
                            insertImageIntoEditText(selectedImageUri);
                            updateCharCount();
                        }
                    }
                }
        );

        addPhotoButton.setOnClickListener(v -> openImagePicker());
        saveButton.setOnClickListener(v -> savePost());
    }

    private void openImagePicker() {
        Intent intent = new Intent(Intent.ACTION_PICK);
        intent.setType("image/*");
        imagePickerLauncher.launch(intent);
    }

    // ✅ EditText 내에 이미지 삽입
    private void insertImageIntoEditText(Uri imageUri) {
        try {
            InputStream inputStream = getContentResolver().openInputStream(imageUri);
            Bitmap bitmap = BitmapFactory.decodeStream(inputStream);
            inputStream.close();

            // 이미지 크기 조정 (텍스트 크기에 맞게)
            int width = editContent.getWidth() - 40;
            int height = (int) ((float) bitmap.getHeight() / bitmap.getWidth() * width);
            Bitmap scaledBitmap = Bitmap.createScaledBitmap(bitmap, width, height, true);

            ImageSpan imageSpan = new ImageSpan(this, scaledBitmap);
            SpannableStringBuilder ssb = new SpannableStringBuilder(editContent.getText());
            int start = editContent.getSelectionStart();
            ssb.insert(start, " ");
            ssb.setSpan(imageSpan, start, start + 1, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
            editContent.setText(ssb);
            editContent.setSelection(start + 1);

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void updateCharCount() {
        int textLength = editContent.getText().toString().length();
        int total = textLength + imageUris.size(); // ✅ 이미지 개수도 1장당 1로 계산
        textCharCount.setText(total + " / " + MAX_CONTENT_LENGTH);
        if (total > MAX_CONTENT_LENGTH) {
            textCharCount.setTextColor(getColor(android.R.color.holo_red_dark));
        } else {
            textCharCount.setTextColor(getColor(android.R.color.darker_gray));
        }
    }

    private void savePost() {
        String title = editTitle.getText().toString().trim();
        String content = editContent.getText().toString().trim();

        if (title.isEmpty() || content.isEmpty()) {
            Toast.makeText(this, "제목과 내용을 입력하세요.", Toast.LENGTH_SHORT).show();
            return;
        }

        int total = content.length() + imageUris.size();
        if (total > MAX_CONTENT_LENGTH) {
            Toast.makeText(this, "사진 포함 1000자 이내로 작성해주세요.", Toast.LENGTH_SHORT).show();
            return;
        }

        String date = new SimpleDateFormat("yyyy-MM-dd HH:mm", Locale.getDefault()).format(new Date());
        BoardPost newPost = new BoardPost(title, content, imageUris, date);

        ArrayList<BoardPost> existingPosts = loadPosts();
        existingPosts.add(0, newPost);
        savePosts(existingPosts);

        Toast.makeText(this, "게시글이 등록되었습니다.", Toast.LENGTH_SHORT).show();

        setResult(Activity.RESULT_OK);
        finish();
    }

    private void savePosts(ArrayList<BoardPost> posts) {
        Gson gson = new Gson();
        String json = gson.toJson(posts);
        getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE)
                .edit()
                .putString(POSTS_KEY, json)
                .apply();
    }

    private ArrayList<BoardPost> loadPosts() {
        String json = getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE)
                .getString(POSTS_KEY, null);
        if (json != null) {
            Gson gson = new Gson();
            Type type = new TypeToken<ArrayList<BoardPost>>() {}.getType();
            return gson.fromJson(json, type);
        }
        return new ArrayList<>();
    }
}
